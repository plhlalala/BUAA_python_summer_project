{% extends "basehome.html" %}
{% block title %}创建问题{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">创建问题</h1>

    <div class="bg-white shadow-md rounded-lg p-6">
        <form method="post" enctype="multipart/form-data" id="questionForm">
            {% csrf_token %}
            <div class="mb-4">
                <label for="title" class="block text-gray-700 font-bold mb-2">问题标题</label>
                {{ form.title }}
            </div>
            <div class="mb-4">
                <label for="description" class="block text-gray-700 font-bold mb-2">问题描述</label>
                {{ form.description }}
            </div>
            <div class="mb-4">
                <label for="format" class="block text-gray-700 font-bold mb-2">问题格式</label>
                {{ form.format }}
            </div>
            <div class="mb-4">
                <label for="question_type" class="block text-gray-700 font-bold mb-2">问题类型</label>
                {{ form.question_type }}
            </div>
            <div class="mb-4">
                <label for="image" class="block text-gray-700 font-bold mb-2">上传图片 (可选)</label>
                {{ form.image }}
            </div>
            <div class="mb-4">
                <label for="correct_answer" class="block text-gray-700 font-bold mb-2">正确答案 (选择题必填)</label>
                {{ form.correct_answer }}
            </div>
            <div class="mb-4">
                <label for="chapters" class="block text-gray-700 font-bold mb-2">章节</label>
                {{ form.chapters }}
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="submitQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                    保存
                </button>
            </div>
        </form>

        <div id="optionsContainer" class="hidden mt-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">添加选项</h2>
            <form method="post" id="optionForm">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="option_text" class="block text-gray-700 font-bold mb-2">选项内容</label>
                    <input type="text" id="option_text" name="option_text" class="form-input mt-1 block w-full">
                </div>
                <div class="mb-4">
                    <label for="is_correct" class="block text-gray-700 font-bold mb-2">是否正确</label>
                    <input type="checkbox" id="is_correct" name="is_correct" class="form-checkbox mt-1">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="addOption()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mr-2">
                        添加选项
                    </button>
                    <button type="button" onclick="finalizeQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        完成
                    </button>
                </div>
            </form>
            <ul id="optionsList" class="mt-4">
                <!-- 选项列表将显示在这里 -->
            </ul>
        </div>
    </div>
</div>

<script>
    function submitQuestion() {
        const formData = new FormData(document.getElementById('questionForm'));
        fetch("{% url 'create_question' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('optionsContainer').classList.remove('hidden');
                document.getElementById('questionForm').classList.add('hidden');
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function addOption() {
        const formData = new FormData(document.getElementById('optionForm'));
        fetch("{% url 'add_option' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const optionList = document.getElementById('optionsList');
                const newOption = document.createElement('li');
                newOption.textContent = `${data.option_text} ${data.is_correct ? '(正确)' : ''}`;
                optionList.appendChild(newOption);
                document.getElementById('optionForm').reset();
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function finalizeQuestion() {
        location.href = "{% url 'question_management' %}";
    }
</script>

{% endblock %}
